<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>render.lua</title>
    <link rel="stylesheet" type="text/css" href="default.css" />
    <script>document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/'+(matchMedia('(prefers-color-scheme:dark)').matches?'github-dark':'github')+'.min.css"/>')</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
<div class="container">
<nav class="sidebar">
<h2>Contents <a href="index.html" class="sidebar-home" title="Home">⌂</a></h2>
<ul id="toc">
<li><a href="#chk">Checks</a></li>
<li><a href="#def">Defines</a></li>
<li class="toc-sub"><a href="#def-1">1. Localize functions for performance</a></li>
<li class="toc-sub"><a href="#def-2">2. Import utils for trim</a></li>
<li class="toc-sub"><a href="#def-3">3. Module table</a></li>
<li class="toc-sub"><a href="#def-4">4. Map tag prefixes to anchor slugs and section titles</a></li>
<li class="toc-sub"><a href="#def-5">5. Line-to-anchor mapping built during grouping</a></li>
<li><a href="#run">Runners</a></li>
<li class="toc-sub"><a href="#run-1">1. Generate a slug from a file path for anchors/filenames</a></li>
<li class="toc-sub"><a href="#run-2">2. Convert @src:filepath:line to clickable markdown links</a></li>
<li class="toc-sub"><a href="#run-3">3. Render a single entry</a></li>
<li class="toc-sub"><a href="#run-4">4. Render index page</a></li>
<li class="toc-sub"><a href="#run-5">5. Render a single file's documentation page</a></li>
<li class="toc-sub"><a href="#run-6">6. Group records by file and assign indices</a></li>
<li class="toc-sub"><a href="#run-7">7. Get slug for a file path</a></li>
</ul>
</nav>
<main class="content">

<h1>render.lua</h1>

<p><code>~/Desktop/autoodocs/lib/render.lua</code></p>

<p>Markdown renderer that generates documentation pages with cross-references</p>

<h2><a id="chk"></a>Checks</h2>

<p><a id="chk-1"></a><strong>1. ~/Desktop/autoodocs/lib/render.lua:134</strong>
<em>↳ <a href="#run-4">@run 4.</a></em></p>

<p>Detect and include README.md content</p>

<pre><code class="language-lua">    local readme_content = nil
    for _, name in ipairs({"README.md", "readme.md"}) do
        local f = io.open((scan_dir or ".") .. "/" .. name, "r")
        if f then
            readme_content = f:read("*a")
            -- Strip autodocs HTML comments
            readme_content = readme_content:gsub("&lt;!%-%- @%w[^&gt;]* %-%-&gt;%s*", "")
            f:close()
            break
        end
    end

    if readme_content then
        w(readme_content .. "\n\n")
    else
        w("Select a file from the sidebar to view its documentation.\n\n")
    end
</code></pre>

<h2><a id="def"></a>Defines</h2>

<h3><a id="def-1"></a>1. Localize functions for performance</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:2</code></p>

<pre><code class="language-lua">local fmt    = string.format
local gmatch = string.gmatch
local concat = table.concat
local gsub   = string.gsub
local match  = string.match
local sub    = string.sub
</code></pre>

<h3><a id="def-2"></a>2. Import utils for trim</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:10</code></p>

<pre><code class="language-lua">local utils = require("lib.utils")
local trim = utils.trim
</code></pre>

<h3><a id="def-3"></a>3. Module table</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:14</code></p>

<pre><code class="language-lua">local M = {}
</code></pre>

<h3><a id="def-4"></a>4. Map tag prefixes to anchor slugs and section titles</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:17</code></p>

<pre><code class="language-lua">M.TAG_SEC   = {GEN="gen", CHK="chk", DEF="def", RUN="run", ERR="err"}
M.TAG_TITLE = {GEN="General", CHK="Checks", DEF="Defines", RUN="Runners", ERR="Errors"}
M.TAG_ORDER = {"GEN", "CHK", "DEF", "RUN", "ERR"}
</code></pre>

<h3><a id="def-5"></a>5. Line-to-anchor mapping built during grouping</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:30</code></p>

<pre><code class="language-lua">M.line_map = {}
</code></pre>

<p><a id="def-6"></a><strong>6. ~/Desktop/autoodocs/lib/render.lua:212</strong>
<em>↳ <a href="#run-5">@run 5.</a></em></p>

<p>Group entries by tag type</p>

<pre><code class="language-lua">    local by_tag = {GEN={}, CHK={}, DEF={}, RUN={}, ERR={}}
    for _, r in ipairs(entries) do
        by_tag[r.tag][#by_tag[r.tag] + 1] = r
    end
</code></pre>

<h2><a id="run"></a>Runners</h2>

<h3><a id="run-1"></a>1. Generate a slug from a file path for anchors/filenames</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:22</code></p>


<h3><a id="run-2"></a>2. Convert @src:filepath:line to clickable markdown links</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:33</code></p>

<pre><code class="language-lua">local function link_sources(text)
    text = gsub(text, "@ref %[(.-)%]%((.-)%)", "*↗ [%1](%2)*")
    return gsub(text, "@src:([^%s:]+):?(%d*)", function(path, line)
        local slug = slugify(path)
        local anchor = ""
        if line ~= "" and M.line_map[slug] then
            local ln = tonumber(line)
            for _, entry in ipairs(M.line_map[slug]) do
                if entry.line &lt;= ln then anchor = entry.anchor
                else break end
            end
        end
        local display = line ~= "" and (path .. ":" .. line) or path
        local href = anchor ~= "" and fmt("%s.html#%s", slug, anchor) or (slug .. ".html")
        return fmt("*↳ [%s](%s)*", display, href)
    end)
end
</code></pre>

<h3><a id="run-3"></a>3. Render a single entry</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:52</code></p>


<p><a id="run-3-1"></a><strong>3.1 ~/Desktop/autoodocs/lib/render.lua:54</strong>
<em>↳ <a href="#run-3">@run 3.</a></em></p>

<p>GEN entries render as plain text, no header</p>

<pre><code class="language-lua">    if r.tag == "GEN" then
        for tline in gmatch(r.text, "[^\031]+") do
            local tr = link_sources(trim(tline))
            if tr ~= "" then w(tr .. "\n\n") end
        end
        return
    end
</code></pre>

<p><a id="run-3-2"></a><strong>3.2 ~/Desktop/autoodocs/lib/render.lua:63</strong>
<em>↳ <a href="#run-3">@run 3.</a></em></p>

<p>Build entry header with anchor and index</p>

<blockquote>
    <p>child entries show parent backlink, top-level entries use h3</p>
</blockquote>

<pre><code class="language-lua">    if r.parent then
        -- Child entry: bold text
        w(fmt('&lt;a id="%s"&gt;&lt;/a&gt;**%s %s**\n', r.anchor, r.idx, r.loc))
        w(fmt("*↳ [@%s %s](#%s)*\n\n", M.TAG_SEC[r.parent.tag], r.parent.idx, r.parent.anchor))
    else
        -- Top-level entry: h3 header (appears in TOC)
        local title = r.text:match("^([^\031]+)") or ""
        title = trim(title)
        if #title &gt; 90 then title = title:sub(1, 87) .. "..." end
        w(fmt('### &lt;a id="%s"&gt;&lt;/a&gt;%s %s\n\n', r.anchor, r.idx, title))
        w(fmt('`%s`\n\n', r.loc))
    end
</code></pre>

<p><a id="run-3-3"></a><strong>3.3 ~/Desktop/autoodocs/lib/render.lua:78</strong>
<em>↳ <a href="#run-3">@run 3.</a></em></p>

<p>Render text lines through link_sources with admonition support</p>

<pre><code class="language-lua">    local skip_first = (not r.parent)

    if r.adm then
        local first_text = true
        for tline in gmatch(r.text, "[^\031]+") do
            local tr = link_sources(trim(tline))
            if tr ~= "" then
                if skip_first then
                    skip_first = false
                elseif first_text then
                    w(fmt("&gt; [!%s]\n&gt; %s\n\n", r.adm, tr))
                    first_text = false
                else
                    w(tr .. "\n\n")
                end
            end
        end
    else
        local first_text = true
        for tline in gmatch(r.text, "[^\031]+") do
            local tr = link_sources(trim(tline))
            if tr ~= "" then
                if skip_first then
                    skip_first = false
                elseif first_text then
                    w(tr .. "\n\n")
                    first_text = false
                else
                    w(fmt("&gt; %s\n\n", tr))
                end
            end
        end
    end
</code></pre>

<h3><a id="run-4"></a>4. Render index page</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:127</code></p>


<p><a id="run-4-1"></a><strong>4.1 ~/Desktop/autoodocs/lib/render.lua:153</strong>
<em>↳ <a href="#run-4">@run 4.</a></em></p>

<p>Find common path prefix and group files by directory</p>

<pre><code class="language-lua">    local prefix = match(file_order[1] or "", "^(.*/)") or ""
    for _, file in ipairs(file_order) do
        while #prefix &gt; 0 and sub(file, 1, #prefix) ~= prefix do
            prefix = match(sub(prefix, 1, -2), "^(.*/)") or ""
        end
    end

    -- Group files: root files first, then by subdirectory
    local root_files = {}
    local dir_files = {}
    for _, file in ipairs(file_order) do
        local rel = sub(file, #prefix + 1)
        local dir = match(rel, "^([^/]+)/")
        if dir then
            dir_files[dir] = dir_files[dir] or {}
            dir_files[dir][#dir_files[dir] + 1] = {file = file, rel = rel}
        else
            root_files[#root_files + 1] = {file = file, rel = rel}
        end
    end
</code></pre>

<p><a id="run-4-2"></a><strong>4.2 ~/Desktop/autoodocs/lib/render.lua:175</strong>
<em>↳ <a href="#run-4">@run 4.</a></em></p>

<p>Write hidden NAV comment for TOC extraction</p>

<pre><code class="language-lua">    w("&lt;!-- NAV\n")
    -- Root files first
    for _, f in ipairs(root_files) do
        local slug = slugify(f.file)
        w(fmt("[%s](%s.html)\n", f.rel, slug))
    end
    -- Then grouped subdirectories
    for dir, files in pairs(dir_files) do
        w(fmt("[&gt;%s]\n", dir))
        for _, f in ipairs(files) do
            local slug = slugify(f.file)
            local basename = match(f.rel, "/(.+)$") or f.rel
            w(fmt("[%s](%s.html)\n", basename, slug))
        end
        w("[&lt;]\n")
    end
    w("--&gt;\n")
</code></pre>

<p><a id="run-4-3"></a><strong>4.3 ~/Desktop/autoodocs/lib/render.lua:194</strong>
<em>↳ <a href="#run-4">@run 4.</a></em></p>

<p>Embed repo URL as HTML comment for sidebar link</p>

<blockquote>
    <p><em>↗ <a href="https://github.com/h8d13/autoodocs" target="_blank">autoodocs</a></em></p>
</blockquote>

<pre><code class="language-lua">    if repo_url then
        w(fmt("&lt;!-- REPO:%s --&gt;\n", repo_url))
    end
</code></pre>

<h3><a id="run-5"></a>5. Render a single file's documentation page</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:203</code></p>


<p><a id="run-5-1"></a><strong>5.1 ~/Desktop/autoodocs/lib/render.lua:218</strong>
<em>↳ <a href="#run-5">@run 5.</a></em></p>

<p>Render each tag section, GEN has no header</p>

<pre><code class="language-lua">    for _, tag in ipairs(M.TAG_ORDER) do
        local tag_entries = by_tag[tag]
        if #tag_entries &gt; 0 then
            if tag ~= "GEN" then
                w(fmt('## &lt;a id="%s"&gt;&lt;/a&gt;%s\n\n', M.TAG_SEC[tag], M.TAG_TITLE[tag]))
            end
            for _, r in ipairs(tag_entries) do
                render_entry(w, r)
            end
        end
    end
</code></pre>

<h3><a id="run-6"></a>6. Group records by file and assign indices</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:234</code></p>


<h3><a id="run-7"></a>7. Get slug for a file path</h3>

<p><code>~/Desktop/autoodocs/lib/render.lua:295</code></p>



<div class="build-timestamp">Generated: 2026-02-15 23:05</div>
</main>
</div>
<script>
hljs.highlightAll();
// Hide home icon on index page
if (location.pathname.endsWith('index.html') || location.pathname.endsWith('/')) {
    var home = document.querySelector('.sidebar-home');
    if (home) home.style.display = 'none';
}
// Highlight active section on scroll
var links = document.querySelectorAll('.sidebar a');
var sections = document.querySelectorAll('.content h2, .content h3');
window.addEventListener('scroll', function() {
    var current = '';
    sections.forEach(function(section) {
        var anchor = section.querySelector('a');
        if (anchor && window.scrollY >= section.offsetTop - 100) {
            current = anchor.id;
        }
    });
    links.forEach(function(link) {
        link.classList.remove('active');
        if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
        }
    });
});
</script>
</body></html>